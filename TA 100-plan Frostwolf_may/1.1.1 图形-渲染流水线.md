# 基本渲染流水线介绍

## 整体流程

* 应用阶段（Application）（CPU）
  * 准备场景基本数据
  * 加速算法、粗粒度剔除
  * 渲染状态设置、准备渲染参数
  * 调用DrawCall，输出渲染图元到显存
* 几何阶段（GPU）
  * 顶点着色（vertex shading）（使用顶点着色器）
  * 可选顶点处理（曲面细分着色器、几何着色器）
  * 裁剪（clipping）
  * 投影（projection）
  * 屏幕映射（screen mapping）
* 光栅化阶段（GPU）
  * 三角形设置（点/线）（triangle setup）
  * 三角形遍历（点/线）（triangle traversal）
  * 逐片元操作（常归于光栅化阶段）
    * 片元着色（fragment shading）(使用片元着色器)
    * 各种测试
      * 裁剪测试
      * 透明度测试
      * 深度测试
      * 模板测试
    * 颜色混合（color blending）
    * 更新帧缓冲（frame buffer）
* 后处理



## 应用阶段

### 准备基本场景数据

* 场景物体数据
  * transform
    * position
    * rotation
    * scale
  * 网格数据
    * 顶点位置
    * uv坐标
    * 法线方向
    * ...
* 摄像机数据
  * position
  * rotation
  * Znear/Zfar
  * Orthographic/Perspective（正交/透视）
  * FOV（field of view）
  * 视口比例
* 光源及阴影数据
  * 光源类型
    * 方向光
    * 点光源
    * 聚光灯
    * 面光源
    * ...
  * 光源参数
    * 位置
    * 方向
    * 角度
    * ...
  * 阴影数据
    * 是否开启阴影（对光照范围内开启阴影投射的物体进行处理）
    * 阴影参数
      * 对应光源序号
      * 阴影强度
      * 级联参数
      * 深度偏移
      * 近平面偏移
      * ...
    * 逐光源绘制阴影贴图
      * 逐级联
        * 计算当前光源+级联对应的观察矩阵、投影矩阵以及对应到阴影贴图中的视口区域
        * 绘制到阴影贴图
* 其他全局数据

### 优化算法等

* 碰撞检测
* 加速算法
  * 根据是否在可见光的光照范围内进行裁剪
* 遮挡剔除（粗粒度剔除）
  * 可见场景物体裁剪
    * 八叉树
    * BSP树
    * K-D树
    * BVH包围盒

### 设置渲染状态，准备渲染参数

* 绘制设置（如指定各个物体的shader）
  * 着色器设置
  * 合批方式
    * GPU instancing
    * 静态批处理
    * 动态批处理
    * ...
* 绘制顺序
  * 相对于摄像机的距离
  * 材质Render queue排序
  * 场景->UI
  * ...
* 渲染目标
  * frame buffer
  * render texture
* 渲染模式
  * 前向渲染
  * 延迟渲染

### 输出到显存

* 顶点数据
  * 位置
  * 颜色
  * 法线方向
  * uv坐标
  * ...
* 其他数据
  * MVP矩阵
  * 纹理贴图
  * ...





## 几何阶段

### 顶点着色器（vertex shading）

* 视图变换
  * 一般经过MVP矩阵变换到裁剪坐标系（不进行透视除法）
* 顶点着色
  * 顶点阶段进行光照计算，效果一般不好，较少使用

### 可选顶点处理

* 曲面细分着色器
  * 操作对象：顶点
  * 生成更多顶点
* 几何着色器
  * 操作对象：图元
    * 一个顶点
    * 二到多个顶点形成的线段
    * 三个顶点形成的三角形
  * 通过给定的图元生成更多的图元
  * 例子：粒子系统中，可用一个顶点表示位置，在几何着色器中扩展为2个三角形组成的矩形

### 裁剪（clipping）

- CVV（视锥体裁剪）
  - 在NDC中，视锥体内的物体坐标都在（-1,1）之间（OpenGL）
  - 若超过该范围，说明不在视锥体内，进行裁剪
    - 完全抛弃
    - 进行裁剪生成新的顶点
- 正面剔除/背面剔除

### 投影（projection）

* 在前面的顶点着色器中，已经将顶点坐标从模型空间转换到裁剪空间
* 在这里进行透视除法（x/w, y/w, z/w, w/w）后，转为标准设备坐标系(NDC)，即为投影操作

* 正交投影
  * w始终为1，透视除法不会改变顶点位置
* 透视投影
  * w近处小，远处大（和z相关），因此透视除法会改变顶点位置，且有近大远小的效果

### 屏幕映射（screen mapping）

* 连续——离散，得到每个顶点在屏幕空间中的离散坐标
* 坐标系差异
  * OpenGL屏幕原点在左下方
  * D3D屏幕原点在左上方



## 光栅化阶段

### 三角形设置（triangle setup）

* 计算三角形的边界信息
* 直线/三角形

### 三角形遍历（triangle traversal）

* 遍历所有像素，根据边界信息判断这个像素是否在三角形中
* 寻找被三角形网格覆盖的所有像素的过程
* 根据三角形三个顶点所在像素的坐标，对三角形内部的像素进行线性插值，得到插值的片元数据
* 一个像素位置可能会同时存在多个三角形的片元

### 抗锯齿（AA-anti aliasing）

* SSAA（Super Sampling Anti Aliasing）：超分辨下进行渲染后，下采样，不在光栅化阶段
* MSAA（Multi-Sampling Anti Aliasing）：一个像素中多个子采样点，判断边界在三角形内部的多少
  * 覆盖测试：判断子采样点是否在三角形内部
  * 遮挡测试：判断子采样点是否通过深度测试
  * 通过测试的信息会被保存，用于后续的逐片元操作（该片元影响这个像素的程度）
* FXAA（Fast Approximate Anti-Aliasing）：后处理，不在光栅化阶段
* TXAA（Temporal Anti-Aliasing）：后处理，不在光栅化阶段

### 逐片元操作

#### 片元着色（fragment shading）

* 使用插值得到的该片元的各种属性进行计算，得到该片元的最终颜色

#### 测试、颜色混合（color blending）

* 透明度测试（alpha test）
* 深度测试（depth test）
* 模板测试（stencil test）
* 混合（blending）

#### 目标缓冲区

* frame buffer
* render texture



## 后处理

* Bloom
* HDR
* FXAA
* Depth of View
* 边缘检测
* 径向模糊







